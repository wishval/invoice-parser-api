---
phase: 05-invoice-crud
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/Http/Resources/InvoiceResource.php
  - app/Http/Resources/InvoiceItemResource.php
  - app/Http/Controllers/Api/InvoiceController.php
  - routes/api.php
autonomous: true
requirements:
  - CRUD-01
  - CRUD-02
  - CRUD-05
  - CRUD-06

must_haves:
  truths:
    - "User can list their own invoices with pagination (15 per page by default)"
    - "User can filter invoice list by status query parameter"
    - "Single invoice response includes all extracted data and line items"
    - "User cannot see invoices belonging to another user"
  artifacts:
    - path: "app/Http/Resources/InvoiceItemResource.php"
      provides: "Line item JSON serialization"
      exports: ["InvoiceItemResource"]
    - path: "app/Http/Resources/InvoiceResource.php"
      provides: "Full invoice JSON with line items, vendor/customer info, confidence scores"
      contains: "InvoiceItemResource"
    - path: "app/Http/Controllers/Api/InvoiceController.php"
      provides: "index method with pagination and status filter"
      contains: "index"
  key_links:
    - from: "app/Http/Controllers/Api/InvoiceController.php"
      to: "app/Http/Resources/InvoiceResource.php"
      via: "InvoiceResource::collection for paginated response"
      pattern: "InvoiceResource::collection"
    - from: "app/Http/Resources/InvoiceResource.php"
      to: "app/Http/Resources/InvoiceItemResource.php"
      via: "nested resource for line items"
      pattern: "InvoiceItemResource::collection"
    - from: "routes/api.php"
      to: "InvoiceController::index"
      via: "GET /invoices route"
      pattern: "Route::get.*invoices.*index"
---

<objective>
Add invoice listing with pagination, status filtering, and enhanced invoice detail response including all extracted data and line items.

Purpose: Users need to browse their parsed invoices and see full extraction results including vendor info, customer info, line items, and confidence scores.
Output: Working GET /invoices (paginated, filterable) and enhanced GET /invoices/{invoice} with complete data.
</objective>

<execution_context>
@/Users/valerijbakalenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/valerijbakalenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/Http/Controllers/Api/InvoiceController.php
@app/Http/Resources/InvoiceResource.php
@app/Models/Invoice.php
@app/Models/InvoiceItem.php
@routes/api.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InvoiceItemResource and enhance InvoiceResource with full extracted data</name>
  <files>app/Http/Resources/InvoiceItemResource.php, app/Http/Resources/InvoiceResource.php</files>
  <action>
1. Create `app/Http/Resources/InvoiceItemResource.php`:
   - Fields: id, description, quantity, unit_price, amount, tax
   - All numeric fields cast properly (they are already decimal-cast on the model)

2. Update `app/Http/Resources/InvoiceResource.php` to include ALL extracted fields:
   - Keep existing: id, status, original_filename, created_at
   - Add vendor info: vendor_name, vendor_address, vendor_tax_id (all whenNotNull)
   - Add customer info: customer_name, customer_address, customer_tax_id (all whenNotNull)
   - Add invoice metadata: invoice_number, invoice_date, due_date, currency (all whenNotNull)
   - Add financials: subtotal, tax_amount, total (all whenNotNull)
   - Add confidence_scores (whenNotNull)
   - Add line items: 'items' => InvoiceItemResource::collection($this->whenLoaded('items'))
   - Keep error_message conditional on status === 'failed'
   - Add updated_at timestamp

Use whenNotNull for all nullable extracted fields so pending/processing invoices return clean JSON without null clutter.
  </action>
  <verify>
Run `php artisan tinker --execute="use App\Http\Resources\InvoiceResource; echo 'OK';"` inside the Docker container to confirm no syntax errors. Check that InvoiceItemResource class exists and is importable.
  </verify>
  <done>InvoiceResource returns all extracted data fields and nested line items via InvoiceItemResource. Pending invoices return only base fields without null clutter.</done>
</task>

<task type="auto">
  <name>Task 2: Add index method with pagination, status filter, and ownership scope</name>
  <files>app/Http/Controllers/Api/InvoiceController.php, routes/api.php</files>
  <action>
1. Add `index()` method to InvoiceController:
   - Query: `$request->user()->invoices()` (scopes to authenticated user's invoices only -- this handles CRUD-06 ownership)
   - Status filter: if `$request->query('status')` is present AND is one of ['pending', 'processing', 'completed', 'failed'], apply `->where('status', $status)`. Ignore invalid status values silently.
   - Eager load: `->with('items')` so line items are included without N+1
   - Order: `->latest()` (newest first)
   - Paginate: `->paginate($request->query('per_page', 15))` -- default 15, allow override
   - Return: `InvoiceResource::collection($invoices)` which automatically includes pagination meta

2. Update `show()` method to eager load items:
   - Add `$invoice->load('items')` before returning the resource
   - The ownership check already exists, keep it as is

3. Add route in `routes/api.php`:
   - Inside the auth:sanctum middleware group, add: `Route::get('/invoices', [InvoiceController::class, 'index']);`
   - Place it BEFORE the `{invoice}` route to avoid route conflicts
  </action>
  <verify>
Run `docker exec invoice_parser_api_app php artisan route:list --path=invoices` and confirm GET /api/v1/invoices is listed with InvoiceController@index.
  </verify>
  <done>GET /api/v1/invoices returns paginated list of authenticated user's invoices. Status filter works via ?status=completed query param. Response includes pagination meta (current_page, last_page, per_page, total). Show endpoint includes line items.</done>
</task>

</tasks>

<verification>
1. `docker exec invoice_parser_api_app php artisan route:list --path=invoices` shows GET /invoices (index) and GET /invoices/{invoice} (show)
2. Curl test listing: `curl -s -H "Authorization: Bearer {token}" http://localhost/api/v1/invoices | jq '.meta.per_page'` returns 15
3. Curl test filter: `curl -s -H "Authorization: Bearer {token}" http://localhost/api/v1/invoices?status=completed | jq '.data'` returns only completed invoices
4. Curl test show: `curl -s -H "Authorization: Bearer {token}" http://localhost/api/v1/invoices/{id} | jq '.data.items'` returns line items array
</verification>

<success_criteria>
- GET /api/v1/invoices returns paginated JSON with default 15 per page
- ?status=completed filters to only completed invoices
- Single invoice response includes vendor_name, customer_name, subtotal, tax_amount, total, currency, confidence_scores, and items array
- Only authenticated user's invoices are returned (no cross-user leakage)
- No N+1 queries on line items
</success_criteria>

<output>
After completion, create `.planning/phases/05-invoice-crud/05-01-SUMMARY.md`
</output>
