---
phase: 05-invoice-crud
plan: 02
type: execute
wave: 2
depends_on:
  - "05-01"
files_modified:
  - app/Http/Controllers/Api/InvoiceController.php
  - routes/api.php
autonomous: true
requirements:
  - CRUD-03
  - CRUD-04
  - CRUD-06

must_haves:
  truths:
    - "User can download the original uploaded PDF"
    - "User can delete an invoice removing both DB record and stored file"
    - "User cannot download or delete another user's invoice"
  artifacts:
    - path: "app/Http/Controllers/Api/InvoiceController.php"
      provides: "download and destroy methods"
      contains: "download"
    - path: "routes/api.php"
      provides: "DELETE and download routes"
      contains: "destroy"
  key_links:
    - from: "InvoiceController::download"
      to: "Storage::disk('local')"
      via: "streaming stored PDF file"
      pattern: "Storage::disk.*download|response.*download"
    - from: "InvoiceController::destroy"
      to: "Storage::disk('local')->delete"
      via: "removing stored PDF before DB delete"
      pattern: "Storage::disk.*delete"
    - from: "routes/api.php"
      to: "InvoiceController"
      via: "DELETE and download routes"
      pattern: "Route::delete|download"
---

<objective>
Add download and delete endpoints for invoices with ownership enforcement.

Purpose: Users need to retrieve their original uploaded PDFs and remove invoices they no longer need.
Output: Working GET /invoices/{invoice}/download and DELETE /invoices/{invoice} endpoints.
</objective>

<execution_context>
@/Users/valerijbakalenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/valerijbakalenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-invoice-crud/05-01-SUMMARY.md
@app/Http/Controllers/Api/InvoiceController.php
@app/Models/Invoice.php
@routes/api.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add download and destroy methods to InvoiceController</name>
  <files>app/Http/Controllers/Api/InvoiceController.php</files>
  <action>
Add two methods to InvoiceController:

1. `download(Invoice $invoice)`:
   - Ownership check: if `$invoice->user_id !== auth()->id()`, abort(403)
   - Verify file exists: `Storage::disk('local')->exists($invoice->stored_path)` -- if not, abort(404, 'File not found.')
   - Return: `Storage::disk('local')->download($invoice->stored_path, $invoice->original_filename)` which streams the file with the original filename as the download name
   - Return type: `\Symfony\Component\HttpFoundation\StreamedResponse`

2. `destroy(Invoice $invoice)`:
   - Ownership check: if `$invoice->user_id !== auth()->id()`, abort(403)
   - Delete stored file: `Storage::disk('local')->delete($invoice->stored_path)` -- do this BEFORE deleting DB record. Don't fail if file is already gone (Storage::delete returns false silently).
   - Delete DB record: `$invoice->delete()` -- cascade deletes handle invoice_items
   - Return: `response()->json(['message' => 'Invoice deleted.'], 200)`

Import `Illuminate\Support\Facades\Storage` at the top (it may already be imported from upload method).
  </action>
  <verify>
Run `docker exec invoice_parser_api_app php artisan tinker --execute="use App\Http\Controllers\Api\InvoiceController; echo 'OK';"` to confirm no syntax errors.
  </verify>
  <done>InvoiceController has download() and destroy() methods with ownership checks. Download streams the original PDF. Delete removes both file and DB record.</done>
</task>

<task type="auto">
  <name>Task 2: Register download and delete routes</name>
  <files>routes/api.php</files>
  <action>
Inside the auth:sanctum middleware group in routes/api.php, add these routes after the existing invoice routes:

```php
Route::get('/invoices/{invoice}/download', [InvoiceController::class, 'download']);
Route::delete('/invoices/{invoice}', [InvoiceController::class, 'destroy']);
```

The final invoice route block should look like:
- GET /invoices (index) -- from Plan 01
- POST /invoices (upload) -- existing
- GET /invoices/{invoice} (show) -- existing
- GET /invoices/{invoice}/download (download) -- new
- DELETE /invoices/{invoice} (destroy) -- new
  </action>
  <verify>
Run `docker exec invoice_parser_api_app php artisan route:list --path=invoices` and confirm all 5 invoice routes are registered: GET index, POST upload, GET show, GET download, DELETE destroy.
  </verify>
  <done>All invoice CRUD routes are registered. DELETE /api/v1/invoices/{invoice} and GET /api/v1/invoices/{invoice}/download are accessible under auth:sanctum middleware.</done>
</task>

</tasks>

<verification>
1. `docker exec invoice_parser_api_app php artisan route:list --path=invoices` shows all 5 routes
2. Curl download test: `curl -s -o /dev/null -w "%{content_type}" -H "Authorization: Bearer {token}" http://localhost/api/v1/invoices/{id}/download` returns application/pdf
3. Curl delete test: `curl -s -X DELETE -H "Authorization: Bearer {token}" http://localhost/api/v1/invoices/{id} | jq '.message'` returns "Invoice deleted."
4. Ownership test: accessing another user's invoice returns 403
</verification>

<success_criteria>
- GET /api/v1/invoices/{id}/download streams the original PDF with correct filename
- DELETE /api/v1/invoices/{id} removes both database record and stored file, returns 200
- Both endpoints return 403 for invoices belonging to other users
- Download returns 404 if file is missing from storage
- Delete cascades to invoice_items via database constraint
</success_criteria>

<output>
After completion, create `.planning/phases/05-invoice-crud/05-02-SUMMARY.md`
</output>
