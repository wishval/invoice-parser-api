---
phase: 06-testing-docs-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/Unit/Services/InvoiceValidatorTest.php
  - tests/Unit/Services/InvoiceParserTest.php
  - tests/Unit/Services/PdfConverterTest.php
autonomous: true
requirements: [TEST-02, TEST-03]

must_haves:
  truths:
    - "Unit tests cover InvoiceValidator with valid data, invalid structure, and total mismatch"
    - "Unit tests cover InvoiceParser with mocked OpenAI facade"
    - "Unit tests cover PdfConverter error handling (missing file, zero pages)"
    - "OpenAI facade is faked in InvoiceParser tests — no real API calls"
  artifacts:
    - path: "tests/Unit/Services/InvoiceValidatorTest.php"
      provides: "Validation logic tests"
      min_lines: 60
    - path: "tests/Unit/Services/InvoiceParserTest.php"
      provides: "Parser tests with mocked OpenAI"
      min_lines: 40
    - path: "tests/Unit/Services/PdfConverterTest.php"
      provides: "PDF converter error handling tests"
      min_lines: 20
  key_links:
    - from: "tests/Unit/Services/InvoiceParserTest.php"
      to: "OpenAI facade"
      via: "OpenAI::fake() or Mockery"
      pattern: "OpenAI|mock|fake"
    - from: "tests/Unit/Services/InvoiceValidatorTest.php"
      to: "app/Services/InvoiceValidator.php"
      via: "Direct instantiation"
      pattern: "new InvoiceValidator|InvoiceValidator"
---

<objective>
Create unit tests for the three service classes: InvoiceValidator, InvoiceParser, and PdfConverter.

Purpose: Satisfy TEST-02 (unit tests cover service layer) and TEST-03 (OpenAI mocked). These tests exercise business logic in isolation without HTTP layer overhead.
Output: Unit test files in tests/Unit/Services/ directory.
</objective>

<execution_context>
@/Users/valerijbakalenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/valerijbakalenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/Services/InvoiceValidator.php
@app/Services/InvoiceParser.php
@app/Services/PdfConverter.php
@app/Data/InvoiceSchema.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for InvoiceValidator</name>
  <files>tests/Unit/Services/InvoiceValidatorTest.php</files>
  <action>
Create tests/Unit/Services/InvoiceValidatorTest.php (PHPUnit, not Pest). The validator is pure logic — no mocking needed, just pass data arrays.

Test cases:
- test_validates_complete_valid_data: Build a full valid invoice data array matching InvoiceSchema structure (vendor, customer, metadata, totals, line_items with 2 items, confidence). Call validate() — should return validated data without throwing.
- test_rejects_missing_vendor: Data without 'vendor' key → InvalidArgumentException
- test_rejects_missing_line_items: Data without 'line_items' key → InvalidArgumentException
- test_rejects_empty_line_items: Data with 'line_items' => [] → InvalidArgumentException (min:1 rule)
- test_rejects_line_item_missing_description: line_items[0] without description → InvalidArgumentException
- test_validate_totals_passes_when_amounts_match: subtotal=100, tax=20, total=120, one line item amount=100, tax=20 → no exception
- test_validate_totals_throws_on_mismatch: total=500 but line items sum to 120 → DomainException with "total mismatch"
- test_validate_totals_skips_when_total_is_null: total=null → no exception (early return)
- test_validate_totals_logs_subtotal_mismatch_but_does_not_throw: subtotal=99 but calculated is 100, total matches → no exception (only logs warning)

Helper method: private function validInvoiceData(): array — returns a complete valid data array reusable across tests.
  </action>
  <verify>Run `docker compose exec app php artisan test tests/Unit/Services/InvoiceValidatorTest.php` — all pass.</verify>
  <done>InvoiceValidator unit tests cover valid data, structural validation failures, and total mismatch logic.</done>
</task>

<task type="auto">
  <name>Task 2: Unit tests for InvoiceParser and PdfConverter</name>
  <files>tests/Unit/Services/InvoiceParserTest.php, tests/Unit/Services/PdfConverterTest.php</files>
  <action>
**tests/Unit/Services/InvoiceParserTest.php:**

Uses openai-php/laravel's testing support. The openai-php/laravel package provides `OpenAI::fake()` for testing. Use it to fake the chat completion response.

Test cases:
- test_parse_returns_decoded_json_from_openai: Create a fake OpenAI response using `OpenAI::fake([CreateResponse::fake(['choices' => [['message' => ['content' => json_encode($expectedData)]]]])])`. Create a real temporary image file (a 1x1 JPEG using GD: `imagecreatetruecolor(1,1)` saved to temp). Call parse([$tempImagePath]). Assert returned array matches $expectedData. Clean up temp file in tearDown.
- test_parse_throws_on_empty_image_paths: parse([]) → RuntimeException "No image paths"
- test_parse_throws_on_missing_image_file: parse(['/nonexistent/file.jpg']) → RuntimeException "Image file not found"
- test_parse_throws_on_invalid_json_response: Fake OpenAI to return non-JSON content string. parse() → RuntimeException "Failed to decode"

For the fake response structure, use: `OpenAI\Resources\ChatResource` and `OpenAI\Responses\Chat\CreateResponse`. Import and use `OpenAI::fake()` which intercepts all calls.

**tests/Unit/Services/PdfConverterTest.php:**

PdfConverter depends on Imagick/Ghostscript (system deps). Test only error handling paths that don't need real PDF processing:
- test_convert_throws_on_missing_pdf: convert('/nonexistent/file.pdf', 1) → RuntimeException "PDF file not found"

Do NOT test actual PDF conversion (requires Ghostscript in test env). The error path test is sufficient for unit coverage of the guard clause.
  </action>
  <verify>Run `docker compose exec app php artisan test tests/Unit/Services/` — all pass.</verify>
  <done>InvoiceParser tests mock OpenAI completely (no real API calls). PdfConverter error handling tested. Service layer has unit test coverage.</done>
</task>

</tasks>

<verification>
- `docker compose exec app php artisan test --testsuite=Unit` passes all tests
- InvoiceParser tests use OpenAI::fake() — zero real API calls
- InvoiceValidator tests cover validation rules and total matching logic
- PdfConverter error handling covered
</verification>

<success_criteria>
- All unit tests pass green
- InvoiceValidator: 9+ test cases covering valid data, structural errors, total validation
- InvoiceParser: 4 test cases with fully mocked OpenAI
- PdfConverter: 1+ test case for error path
- No test requires external services (OpenAI, Ghostscript)
</success_criteria>

<output>
After completion, create `.planning/phases/06-testing-docs-polish/06-02-SUMMARY.md`
</output>
