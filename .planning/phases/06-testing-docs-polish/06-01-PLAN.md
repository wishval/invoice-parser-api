---
phase: 06-testing-docs-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/Feature/AuthTest.php
  - tests/Feature/InvoiceUploadTest.php
  - tests/Feature/InvoiceCrudTest.php
  - database/factories/InvoiceFactory.php
  - database/factories/InvoiceItemFactory.php
  - phpunit.xml
autonomous: true
requirements: [TEST-01, TEST-03, TEST-04]

must_haves:
  truths:
    - "Feature tests cover health, login, logout, upload, index, show, download, delete endpoints"
    - "All tests run without real OpenAI calls — OpenAI facade is faked/mocked"
    - "Tests verify ownership enforcement (403 for other user's invoices)"
    - "Tests verify validation (non-PDF rejected, missing fields rejected)"
    - "Tests use RefreshDatabase and model factories for clean state"
  artifacts:
    - path: "tests/Feature/AuthTest.php"
      provides: "Login/logout endpoint tests"
      min_lines: 40
    - path: "tests/Feature/InvoiceUploadTest.php"
      provides: "Upload endpoint tests with mocked queue"
      min_lines: 40
    - path: "tests/Feature/InvoiceCrudTest.php"
      provides: "Index, show, download, delete endpoint tests"
      min_lines: 80
    - path: "database/factories/InvoiceFactory.php"
      provides: "Invoice model factory"
    - path: "database/factories/InvoiceItemFactory.php"
      provides: "InvoiceItem model factory"
  key_links:
    - from: "tests/Feature/InvoiceCrudTest.php"
      to: "database/factories/InvoiceFactory.php"
      via: "Invoice::factory()"
      pattern: "Invoice::factory"
    - from: "tests/Feature/InvoiceUploadTest.php"
      to: "Bus facade"
      via: "Bus::fake() to prevent real job dispatch"
      pattern: "Bus::fake"
---

<objective>
Create comprehensive feature tests for all API endpoints: health check, auth (login/logout), invoice upload, and invoice CRUD (index, show, download, delete).

Purpose: Satisfy TEST-01 (feature tests cover all endpoints) and TEST-03 (OpenAI mocked). These tests exercise the full HTTP layer with authentication, validation, authorization, and response structure assertions.
Output: Feature test files, model factories, updated phpunit.xml for SQLite in-memory testing.
</objective>

<execution_context>
@/Users/valerijbakalenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/valerijbakalenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@routes/api.php
@app/Http/Controllers/Api/AuthController.php
@app/Http/Controllers/Api/InvoiceController.php
@app/Http/Requests/StoreInvoiceRequest.php
@app/Models/Invoice.php
@app/Models/InvoiceItem.php
@app/Models/User.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create model factories and configure test database</name>
  <files>database/factories/InvoiceFactory.php, database/factories/InvoiceItemFactory.php, phpunit.xml</files>
  <action>
1. Create InvoiceFactory:
   - user_id via User::factory()
   - original_filename: fake()->word().'.pdf'
   - stored_path: 'invoices/'.fake()->uuid().'.pdf'
   - status: 'completed' (default, can override)
   - invoice_number, invoice_date, due_date, currency: realistic fakes
   - vendor_name, vendor_address, vendor_tax_id: realistic fakes
   - customer_name, customer_address, customer_tax_id: realistic fakes
   - subtotal, tax_amount, total: numeric values where total = subtotal + tax_amount
   - confidence_scores: ['vendor' => 90, 'customer' => 85, 'metadata' => 95, 'totals' => 88, 'line_items' => 92]
   - Add state methods: pending(), processing(), failed()

2. Create InvoiceItemFactory:
   - invoice_id via Invoice::factory()
   - description: fake()->sentence(3)
   - quantity: fake()->randomFloat(3, 1, 100)
   - unit_price: fake()->randomFloat(2, 1, 1000)
   - amount: calculated from quantity * unit_price
   - tax: nullable, sometimes null

3. Update phpunit.xml: Uncomment the DB_CONNECTION=sqlite and DB_DATABASE=:memory: lines so tests use in-memory SQLite (fast, no Docker dependency for tests).
  </action>
  <verify>Run `docker compose exec app php artisan tinker --execute="App\Models\Invoice::factory()->make()"` to confirm factory loads without errors.</verify>
  <done>InvoiceFactory and InvoiceItemFactory exist with realistic defaults and state methods. phpunit.xml uses SQLite in-memory.</done>
</task>

<task type="auto">
  <name>Task 2: Create feature tests for all API endpoints</name>
  <files>tests/Feature/AuthTest.php, tests/Feature/InvoiceUploadTest.php, tests/Feature/InvoiceCrudTest.php</files>
  <action>
All test classes use PHPUnit (not Pest — Pest is not installed). Use `use Illuminate\Foundation\Testing\RefreshDatabase;` in every test class.

**tests/Feature/AuthTest.php:**
- test_health_endpoint_returns_ok: GET /api/v1/health → 200, json has status=ok
- test_login_with_valid_credentials: Create user, POST /api/v1/login with email+password → 200, json has 'token' and 'user' keys
- test_login_with_invalid_credentials: POST /api/v1/login with wrong password → 422, json has errors.email
- test_login_requires_email_and_password: POST /api/v1/login with empty body → 422
- test_logout_revokes_token: Login, then POST /api/v1/logout with bearer → 200, then GET /api/v1/user with same token → 401
- test_unauthenticated_access_returns_401: GET /api/v1/user without token → 401 JSON (not redirect)

**tests/Feature/InvoiceUploadTest.php:**
- test_upload_pdf_returns_202: actingAs user, POST /api/v1/invoices with a fake PDF (UploadedFile::fake()->create('invoice.pdf', 100, 'application/pdf')), use Bus::fake() to prevent job dispatch → 202, json has data.status=pending
- test_upload_rejects_non_pdf: Upload a .txt file → 422
- test_upload_rejects_oversized_file: Upload 11MB PDF → 422
- test_upload_requires_authentication: POST without auth → 401
- Use Bus::fake() in all upload tests to prevent actual job chain dispatch. No OpenAI calls happen in upload tests (jobs are faked).

**tests/Feature/InvoiceCrudTest.php:**
- test_index_returns_paginated_invoices: Create 3 invoices for user, GET /api/v1/invoices → 200, json data count is 3, has meta.current_page
- test_index_filters_by_status: Create 2 completed + 1 pending, GET /api/v1/invoices?status=completed → 2 results
- test_index_only_shows_own_invoices: Create invoice for other user, GET /api/v1/invoices → 0 results
- test_show_returns_invoice_with_items: Create invoice with 2 items, GET /api/v1/invoices/{id} → 200, json has data.items array with 2 entries
- test_show_returns_403_for_other_users_invoice: Create invoice for user B, actingAs user A, GET → 403
- test_show_returns_404_for_nonexistent_invoice: GET /api/v1/invoices/99999 → 404
- test_download_returns_pdf_file: Create invoice, store a fake file at stored_path using Storage::fake('local'), GET /api/v1/invoices/{id}/download → 200 with content-disposition header
- test_download_returns_403_for_other_users_invoice: Same ownership check
- test_delete_removes_invoice_and_file: Create invoice with stored file (Storage::fake), DELETE → 200, assertDatabaseMissing, Storage::assertMissing
- test_delete_returns_403_for_other_users_invoice: Ownership check
  </action>
  <verify>Run `docker compose exec app php artisan test --testsuite=Feature` — all tests pass with 0 failures.</verify>
  <done>Feature tests exist for all 8 API endpoints (health, login, logout, upload, index, show, download, delete) with auth, validation, and ownership assertions. No real OpenAI calls made.</done>
</task>

</tasks>

<verification>
- `docker compose exec app php artisan test --testsuite=Feature` passes all tests
- No test makes a real HTTP call to OpenAI (upload tests use Bus::fake, CRUD tests work with completed invoices from factory)
- Tests cover: happy path, validation errors, auth errors, ownership enforcement
</verification>

<success_criteria>
- All feature tests pass green
- Auth endpoints tested (login valid/invalid, logout, unauthenticated)
- Upload tested (valid PDF, non-PDF rejection, oversize rejection)
- CRUD tested (index with pagination/filter, show with items, download, delete, ownership 403)
- Model factories produce valid Invoice and InvoiceItem records
</success_criteria>

<output>
After completion, create `.planning/phases/06-testing-docs-polish/06-01-SUMMARY.md`
</output>
