---
phase: 03-upload-queue-processing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker/nginx/default.conf
  - docker/php/Dockerfile
  - app/Http/Requests/StoreInvoiceRequest.php
  - app/Http/Resources/InvoiceResource.php
  - app/Http/Controllers/Api/InvoiceController.php
  - routes/api.php
autonomous: true
requirements: [UPLD-01, UPLD-02, UPLD-03, UPLD-04, UPLD-05]

must_haves:
  truths:
    - "User can upload a PDF via multipart POST to /api/v1/invoices and receives 202 with invoice ID and status pending"
    - "Non-PDF files are rejected with 422 and clear error message"
    - "Files exceeding 10MB are rejected with 422 and clear error message"
    - "Original PDF is stored in private storage at storage/app/private/invoices/"
    - "Nginx and PHP accept files up to 20MB (buffer above 10MB validation limit)"
  artifacts:
    - path: "app/Http/Requests/StoreInvoiceRequest.php"
      provides: "PDF upload validation (mimes:pdf, max:10240)"
      contains: "mimes:pdf"
    - path: "app/Http/Resources/InvoiceResource.php"
      provides: "Consistent invoice JSON response"
      exports: ["InvoiceResource"]
    - path: "app/Http/Controllers/Api/InvoiceController.php"
      provides: "Upload endpoint returning 202"
      contains: "setStatusCode(202)"
    - path: "routes/api.php"
      provides: "POST /api/v1/invoices route"
      contains: "invoices"
  key_links:
    - from: "routes/api.php"
      to: "app/Http/Controllers/Api/InvoiceController.php"
      via: "Route::post('/invoices')"
      pattern: "InvoiceController.*upload"
    - from: "app/Http/Controllers/Api/InvoiceController.php"
      to: "app/Http/Requests/StoreInvoiceRequest.php"
      via: "type-hinted form request injection"
      pattern: "StoreInvoiceRequest"
    - from: "app/Http/Controllers/Api/InvoiceController.php"
      to: "app/Http/Resources/InvoiceResource.php"
      via: "return new InvoiceResource"
      pattern: "InvoiceResource"
---

<objective>
Create the PDF upload endpoint with file validation, private storage, and 202 Accepted response.

Purpose: Users can upload PDF invoices and get an immediate response with invoice ID while the file is stored for async processing.
Output: Working POST /api/v1/invoices endpoint that validates, stores, and returns 202.
</objective>

<execution_context>
@/Users/valerijbakalenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/valerijbakalenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-upload-queue-processing/03-RESEARCH.md
@app/Models/Invoice.php
@routes/api.php
@docker/nginx/default.conf
@docker/php/Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Docker upload limits and create Form Request</name>
  <files>
    docker/nginx/default.conf
    docker/php/Dockerfile
    app/Http/Requests/StoreInvoiceRequest.php
  </files>
  <action>
1. Update docker/nginx/default.conf: Add `client_max_body_size 20M;` inside the server block (above the location blocks). This buffers above the 10MB Laravel validation limit to prevent Nginx 413 errors.

2. Update docker/php/Dockerfile: Add a php.ini configuration step AFTER the extensions are installed. Create a custom php.ini with:
   - `upload_max_filesize = 20M`
   - `post_max_size = 20M`
   Use `RUN echo` to write these to `/usr/local/etc/php/conf.d/uploads.ini` (before the USER www-data line).

3. Create app/Http/Requests/StoreInvoiceRequest.php:
   - Extends FormRequest
   - authorize() returns true (Sanctum middleware handles auth)
   - rules(): `'pdf' => ['required', 'file', 'mimes:pdf', 'max:10240']` (10MB in KB)
   - messages(): Custom messages for each rule:
     - pdf.required: "Please provide a PDF file to upload"
     - pdf.file: "The uploaded file is invalid"
     - pdf.mimes: "Only PDF files are accepted"
     - pdf.max: "PDF must not exceed 10MB in size"

After creating files, rebuild Docker: `docker-compose build --no-cache app && docker-compose up -d`
  </action>
  <verify>
Run: `docker-compose exec app php -i | grep upload_max_filesize` -- should show 20M.
Run: `docker-compose exec nginx nginx -T 2>/dev/null | grep client_max_body_size` -- should show 20M.
Run: `docker-compose exec app php artisan tinker --execute="echo class_exists(App\Http\Requests\StoreInvoiceRequest::class) ? 'exists' : 'missing';"` -- should print "exists".
  </verify>
  <done>Nginx accepts 20MB bodies, PHP accepts 20MB uploads, StoreInvoiceRequest validates PDF mime type and 10MB size limit with custom error messages.</done>
</task>

<task type="auto">
  <name>Task 2: Create InvoiceResource, InvoiceController upload endpoint, and route</name>
  <files>
    app/Http/Resources/InvoiceResource.php
    app/Http/Controllers/Api/InvoiceController.php
    routes/api.php
  </files>
  <action>
1. Create app/Http/Resources/InvoiceResource.php:
   - Extends JsonResource
   - toArray() returns:
     - id, status, original_filename
     - created_at as toIso8601String()
     - Conditional fields (whenNotNull): invoice_number, vendor_name, total, currency
     - error_message: only when status === 'failed' using $this->when()
   - This resource will be reused in Phase 5 CRUD.

2. Create app/Http/Controllers/Api/InvoiceController.php:
   - Namespace: App\Http\Controllers\Api
   - Method: upload(StoreInvoiceRequest $request): JsonResponse
   - Implementation:
     a. Store file: `$path = Storage::disk('local')->putFile('invoices', $request->file('pdf'));`
        This stores to storage/app/private/invoices/ with auto-generated unique filename.
     b. Create Invoice record:
        ```
        $invoice = Invoice::create([
            'user_id' => $request->user()->id,
            'original_filename' => $request->file('pdf')->getClientOriginalName(),
            'stored_path' => $path,
            'status' => 'pending',
        ]);
        ```
     c. Return 202: `return (new InvoiceResource($invoice))->response()->setStatusCode(202);`
   - NOTE: Job dispatch will be added in Plan 02. For now the endpoint creates the record and returns 202. This is intentional -- the upload works end-to-end, job chain comes next.

3. Update routes/api.php:
   - Import InvoiceController at top
   - Inside the auth:sanctum middleware group, add:
     `Route::post('/invoices', [InvoiceController::class, 'upload'])->middleware('throttle:parse');`
   - The 'parse' rate limiter (10/min) was defined in Phase 2.

After creating files, verify the endpoint works end-to-end.
  </action>
  <verify>
1. Rebuild (if not done): `docker-compose up -d`
2. Login to get token: `TOKEN=$(curl -s http://localhost:8000/api/v1/login -H 'Content-Type: application/json' -d '{"email":"test@example.com","password":"password"}' | python3 -c "import sys,json; print(json.load(sys.stdin)['data']['token'])")`
3. Upload a PDF: Create a tiny valid PDF first:
   `echo '%PDF-1.0 1 0 obj<</Pages 2 0 R>>endobj 2 0 obj<</Kids[3 0 R]/Count 1>>endobj 3 0 obj<</MediaBox[0 0 3 3]>>endobj trailer<</Root 1 0 R>>' > /tmp/test.pdf`
   Then: `curl -s -w "\n%{http_code}" http://localhost:8000/api/v1/invoices -H "Authorization: Bearer $TOKEN" -F "pdf=@/tmp/test.pdf"`
   Should return 202 with JSON containing id, status "pending", original_filename.
4. Test rejection of non-PDF: `curl -s -w "\n%{http_code}" http://localhost:8000/api/v1/invoices -H "Authorization: Bearer $TOKEN" -F "pdf=@/tmp/test.txt"` (create a .txt first) -- should return 422.
5. Test unauthenticated: `curl -s -w "\n%{http_code}" http://localhost:8000/api/v1/invoices -F "pdf=@/tmp/test.pdf"` -- should return 401.
  </verify>
  <done>POST /api/v1/invoices accepts authenticated multipart PDF upload, validates file type and size, stores PDF to private storage, creates invoice record with status "pending", returns 202 Accepted with InvoiceResource JSON. Non-PDF rejected with 422, unauthenticated rejected with 401.</done>
</task>

</tasks>

<verification>
1. Docker PHP upload limit is 20M (buffers above 10MB validation)
2. Docker Nginx client_max_body_size is 20M
3. POST /api/v1/invoices with valid PDF returns 202 + JSON with id and status "pending"
4. POST /api/v1/invoices with .txt file returns 422 with "Only PDF files are accepted"
5. POST /api/v1/invoices with >10MB PDF returns 422 with size error
6. POST /api/v1/invoices without auth returns 401
7. Uploaded PDF exists in storage/app/private/invoices/ directory
8. Invoice record created in database with correct user_id, filename, path, status
</verification>

<success_criteria>
- Authenticated user uploads PDF, receives 202 with invoice ID
- Non-PDF and oversized files rejected with clear errors
- PDF stored in private storage for later retrieval
- Route protected by auth:sanctum and throttle:parse middleware
</success_criteria>

<output>
After completion, create `.planning/phases/03-upload-queue-processing/03-01-SUMMARY.md`
</output>
