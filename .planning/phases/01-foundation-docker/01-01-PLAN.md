---
phase: 01-foundation-docker
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker/php/Dockerfile
  - docker/php/entrypoint.sh
  - docker/nginx/default.conf
  - docker-compose.yml
  - .env.example
  - .gitignore
autonomous: true
requirements:
  - DEVP-01
  - DEVP-02

must_haves:
  truths:
    - "Running docker-compose up -d starts PHP-FPM, Nginx, and Redis containers"
    - "PHP container has Imagick extension loaded"
    - "PHP container has Ghostscript installed and accessible"
    - "Nginx proxies requests to PHP-FPM and serves Laravel public directory"
    - "Redis is reachable from the PHP container"
    - "Laravel project is scaffolded with all dependencies installed"
  artifacts:
    - path: "docker/php/Dockerfile"
      provides: "PHP 8.3-FPM image with Imagick, Ghostscript, Redis extension"
      contains: "imagick"
    - path: "docker/php/entrypoint.sh"
      provides: "Container startup script that runs composer install and migrations"
      contains: "php artisan migrate"
    - path: "docker/nginx/default.conf"
      provides: "Nginx vhost proxying to PHP-FPM"
      contains: "fastcgi_pass app:9000"
    - path: "docker-compose.yml"
      provides: "Multi-service orchestration"
      contains: "services:"
    - path: ".env.example"
      provides: "Environment template with Redis queue config"
      contains: "QUEUE_CONNECTION=redis"
  key_links:
    - from: "docker-compose.yml"
      to: "docker/php/Dockerfile"
      via: "build context reference"
      pattern: "dockerfile.*docker/php/Dockerfile"
    - from: "docker-compose.yml"
      to: "docker/nginx/default.conf"
      via: "volume mount"
      pattern: "docker/nginx/default.conf"
    - from: "docker/nginx/default.conf"
      to: "app:9000"
      via: "fastcgi_pass directive"
      pattern: "fastcgi_pass app:9000"
---

<objective>
Set up the complete Docker infrastructure and scaffold the Laravel 11 project.

Purpose: Establish the containerized development environment that all subsequent phases build upon. The stack must run with a single `docker-compose up -d` command.
Output: Working Docker Compose stack (PHP-FPM + Nginx + Redis) with a scaffolded Laravel 11 project.
</objective>

<execution_context>
@/Users/valerijbakalenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/valerijbakalenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-docker/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Docker infrastructure files</name>
  <files>docker/php/Dockerfile, docker/php/entrypoint.sh, docker/nginx/default.conf, docker-compose.yml</files>
  <action>
Create the following Docker infrastructure files:

**docker/php/Dockerfile:**
- Base image: `php:8.3-fpm` (Debian-based, NOT Alpine -- easier Imagick install)
- Install system dependencies: git, unzip, libzip-dev, libpng-dev, libjpeg-dev, libfreetype6-dev, libmagickwand-dev, ghostscript
- Install PHP extensions via docker-php-ext-install: pdo_sqlite, zip, bcmath, gd (with freetype+jpeg), pcntl
- Install Imagick via PECL: `pecl install imagick-3.8.1 && docker-php-ext-enable imagick`
- Install Redis extension via PECL: `pecl install redis && docker-php-ext-enable redis`
- Modify ImageMagick policy.xml to allow PDF read/write operations (check both /etc/ImageMagick-6/ and /etc/ImageMagick-7/)
- Copy Composer from `composer:2` image
- Add `env[PATH] = /usr/local/bin:/usr/bin:/bin` to PHP-FPM www.conf (so Ghostscript is found in web context)
- Set WORKDIR to /var/www/html
- Copy entrypoint.sh and set as ENTRYPOINT
- CMD ["php-fpm"]

**docker/php/entrypoint.sh:**
- Make executable (chmod +x)
- Run `composer install --no-interaction --optimize-autoloader` if vendor/ does not exist
- Copy .env from .env.example if .env does not exist
- Run `php artisan key:generate --no-interaction` if APP_KEY is empty
- Create database/database.sqlite if it does not exist and touch it
- Run `php artisan migrate --force`
- Execute CMD (`exec "$@"`)

**docker/nginx/default.conf:**
- Listen on port 80
- Root: /var/www/html/public
- Standard Laravel try_files: `$uri $uri/ /index.php?$query_string`
- PHP location block: fastcgi_pass app:9000
- Deny dotfiles except .well-known
- Disable access_log for favicon.ico and robots.txt

**docker-compose.yml:**
- Service `app`: build from docker/php/Dockerfile, volume mount `.:/var/www/html`, depends_on redis (with healthcheck condition), env vars from .env file
- Service `nginx`: image nginx:1.24-alpine, ports 8000:80, volumes for project root (read-only) and nginx config, depends_on app
- Service `redis`: image redis:7-alpine, healthcheck using redis-cli ping
- Default network connecting all services
  </action>
  <verify>
Run `docker-compose config` from the project root to validate the compose file syntax. Verify all four files exist:
- `ls docker/php/Dockerfile docker/php/entrypoint.sh docker/nginx/default.conf docker-compose.yml`
  </verify>
  <done>All four Docker infrastructure files exist with correct content. docker-compose.yml defines app, nginx, and redis services. Dockerfile installs Imagick, Ghostscript, and Redis extension. Entrypoint handles composer install, migrations, and key generation.</done>
</task>

<task type="auto">
  <name>Task 2: Scaffold Laravel 11 project and configure environment</name>
  <files>.env.example, .gitignore, composer.json</files>
  <action>
Scaffold the Laravel 11 project into the current directory using Docker (to ensure PHP 8.3 compatibility):

1. Run a temporary container to create the Laravel project:
   ```
   docker run --rm -v $(pwd):/app -w /app composer:2 create-project laravel/laravel:^11.0 tmp-laravel --no-interaction
   ```
   Then move all files from tmp-laravel/ to project root (preserving .git and .planning).

2. After scaffolding, build and start the Docker stack:
   ```
   docker-compose up -d --build
   ```

3. Inside the running app container, install API routes:
   ```
   docker-compose exec app php artisan install:api
   ```
   This creates routes/api.php and installs Sanctum.

4. Update `.env.example` to set:
   - APP_NAME="Invoice Parser API"
   - APP_URL=http://localhost:8000
   - DB_CONNECTION=sqlite (should already be default)
   - QUEUE_CONNECTION=redis
   - REDIS_HOST=redis
   - REDIS_PORT=6379
   - CACHE_STORE=redis
   - SESSION_DRIVER=redis

5. Update `.gitignore` to include:
   - database/database.sqlite (add if not present)
   - .env (should already be there)

6. Verify the containers are running and Laravel responds:
   ```
   docker-compose exec app php artisan --version
   docker-compose exec app php -m | grep imagick
   docker-compose exec app gs --version
   curl http://localhost:8000
   ```

Important: Do NOT run composer on the host machine. All PHP/Composer commands run inside Docker containers.
  </action>
  <verify>
All three checks must pass:
1. `docker-compose ps` shows app, nginx, redis all running (healthy/up)
2. `docker-compose exec app php -m | grep imagick` outputs "imagick"
3. `curl -s http://localhost:8000 | head -20` returns the Laravel welcome page HTML
  </verify>
  <done>Laravel 11 project is scaffolded in the project root. Docker stack starts with `docker-compose up -d`. PHP container has Imagick and Ghostscript. Redis is running and configured as queue/cache driver. Nginx serves Laravel on port 8000.</done>
</task>

</tasks>

<verification>
1. `docker-compose up -d` starts all three services without errors
2. `docker-compose exec app php -m` includes imagick, redis, pdo_sqlite, gd, bcmath, pcntl, zip
3. `docker-compose exec app gs --version` returns Ghostscript version
4. `docker-compose exec app php artisan --version` returns Laravel 11.x
5. `curl http://localhost:8000` returns a response (Laravel welcome or default page)
6. Redis is reachable: `docker-compose exec app php artisan tinker --execute="echo Redis::ping();"`
</verification>

<success_criteria>
- docker-compose up -d starts PHP-FPM, Nginx, and Redis with no manual steps beyond .env
- PHP container includes Imagick extension and Ghostscript binary
- Laravel 11 project is scaffolded with Sanctum installed
- .env.example has QUEUE_CONNECTION=redis and REDIS_HOST=redis
- Nginx serves Laravel application on localhost:8000
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-docker/01-01-SUMMARY.md`
</output>
