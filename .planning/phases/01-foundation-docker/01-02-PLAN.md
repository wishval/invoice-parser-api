---
phase: 01-foundation-docker
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - database/migrations/0001_01_01_000003_create_invoices_table.php
  - database/migrations/0001_01_01_000004_create_invoice_items_table.php
  - app/Models/Invoice.php
  - app/Models/InvoiceItem.php
  - bootstrap/app.php
  - routes/api.php
autonomous: true
requirements:
  - INFR-04

must_haves:
  truths:
    - "API routes respond under /api/v1/ prefix"
    - "GET /api/v1/health returns JSON with status ok"
    - "Database migrations create invoices and invoice_items tables"
    - "Invoice model has relationship to InvoiceItem"
    - "InvoiceItem model has relationship to Invoice"
  artifacts:
    - path: "database/migrations/0001_01_01_000003_create_invoices_table.php"
      provides: "Invoices table with all required columns"
      contains: "create_invoices_table"
    - path: "database/migrations/0001_01_01_000004_create_invoice_items_table.php"
      provides: "Invoice items table with line item columns"
      contains: "create_invoice_items_table"
    - path: "app/Models/Invoice.php"
      provides: "Invoice Eloquent model"
      contains: "class Invoice"
    - path: "app/Models/InvoiceItem.php"
      provides: "InvoiceItem Eloquent model"
      contains: "class InvoiceItem"
    - path: "bootstrap/app.php"
      provides: "API prefix configuration"
      contains: "apiPrefix"
    - path: "routes/api.php"
      provides: "Health check route"
      contains: "/health"
  key_links:
    - from: "bootstrap/app.php"
      to: "routes/api.php"
      via: "apiPrefix configuration"
      pattern: "apiPrefix.*api/v1"
    - from: "app/Models/Invoice.php"
      to: "app/Models/InvoiceItem.php"
      via: "hasMany relationship"
      pattern: "hasMany.*InvoiceItem"
    - from: "database/migrations/0001_01_01_000004_create_invoice_items_table.php"
      to: "invoices table"
      via: "foreign key constraint"
      pattern: "foreignId.*invoice_id.*constrained"
---

<objective>
Create database migrations, Eloquent models, and configure API versioning under /api/v1/.

Purpose: Establish the data layer (invoices + invoice_items tables) and the API routing structure that all subsequent phases will use.
Output: Working migrations, models with relationships, and a /api/v1/health endpoint returning JSON.
</objective>

<execution_context>
@/Users/valerijbakalenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/valerijbakalenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-docker/01-RESEARCH.md
@.planning/phases/01-foundation-docker/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migrations and Eloquent models</name>
  <files>database/migrations/0001_01_01_000003_create_invoices_table.php, database/migrations/0001_01_01_000004_create_invoice_items_table.php, app/Models/Invoice.php, app/Models/InvoiceItem.php</files>
  <action>
Create two migration files and two Eloquent models.

**Migration: create_invoices_table**
Use timestamp-based naming that sorts after Laravel's default migrations. Create the invoices table with these columns:
- id (bigIncrements, primary key)
- user_id (foreignId, constrained to users table, cascadeOnDelete)
- original_filename (string)
- stored_path (string)
- status (string, default 'pending') -- values: pending, processing, completed, failed
- invoice_number (string, nullable)
- invoice_date (date, nullable)
- due_date (date, nullable)
- currency (string, 3 chars, nullable)
- vendor_name (string, nullable)
- vendor_address (text, nullable)
- vendor_tax_id (string, nullable)
- customer_name (string, nullable)
- customer_address (text, nullable)
- customer_tax_id (string, nullable)
- subtotal (decimal 12,2, nullable)
- tax_amount (decimal 12,2, nullable)
- total (decimal 12,2, nullable)
- error_message (text, nullable)
- timestamps
- Index on status
- Index on user_id (in addition to the foreign key index)

**Migration: create_invoice_items_table**
- id (bigIncrements, primary key)
- invoice_id (foreignId, constrained to invoices table, cascadeOnDelete)
- description (string)
- quantity (decimal 10,3, default 1)
- unit_price (decimal 12,2)
- amount (decimal 12,2)
- tax (decimal 12,2, nullable)
- timestamps

**Model: Invoice.php**
- Namespace: App\Models
- Extends Model, uses HasFactory
- $fillable array with all columns except id and timestamps
- $casts: invoice_date and due_date as 'date', subtotal/tax_amount/total as 'decimal:2', status as string
- Relationships: belongsTo(User), hasMany(InvoiceItem, 'invoice_id')

**Model: InvoiceItem.php**
- Namespace: App\Models
- Extends Model, uses HasFactory
- $fillable: description, quantity, unit_price, amount, tax, invoice_id
- $casts: quantity as 'decimal:3', unit_price/amount/tax as 'decimal:2'
- Relationships: belongsTo(Invoice)

Run migrations inside Docker: `docker-compose exec app php artisan migrate --force`
  </action>
  <verify>
1. `docker-compose exec app php artisan migrate:status` shows all migrations as "Ran"
2. `docker-compose exec app php artisan tinker --execute="echo Schema::hasTable('invoices') ? 'yes' : 'no';"` outputs "yes"
3. `docker-compose exec app php artisan tinker --execute="echo Schema::hasTable('invoice_items') ? 'yes' : 'no';"` outputs "yes"
  </verify>
  <done>Both migrations run successfully. invoices table has all 20+ columns with proper types, indexes, and foreign key to users. invoice_items table has foreign key to invoices with cascadeOnDelete. Both Eloquent models have fillable arrays, casts, and relationships defined.</done>
</task>

<task type="auto">
  <name>Task 2: Configure API v1 prefix and health route</name>
  <files>bootstrap/app.php, routes/api.php</files>
  <action>
Configure Laravel 11 API versioning and add a health check endpoint.

**bootstrap/app.php:**
Modify the existing `withRouting()` call to include:
- `api: __DIR__.'/../routes/api.php'`
- `apiPrefix: 'api/v1'`
Keep all other existing configuration (web routes, commands, health endpoint).

**routes/api.php:**
Replace the default content (if any scaffolded routes exist) with a clean health check route:

```php
use Illuminate\Support\Facades\Route;

Route::get('/health', function () {
    return response()->json([
        'status' => 'ok',
        'version' => 'v1',
        'timestamp' => now()->toIso8601String(),
    ]);
});
```

This route will be accessible at `GET /api/v1/health` due to the apiPrefix configuration.

After updating files, clear route cache inside Docker:
`docker-compose exec app php artisan route:clear`
  </action>
  <verify>
1. `docker-compose exec app php artisan route:list --path=api` shows the /api/v1/health route
2. `curl -s http://localhost:8000/api/v1/health | python3 -m json.tool` returns JSON with status "ok" and version "v1"
3. `curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/api/v1/health` returns 200
  </verify>
  <done>API routes are versioned under /api/v1/ prefix. GET /api/v1/health returns JSON {"status": "ok", "version": "v1", "timestamp": "..."}. Route list confirms the api/v1 prefix is applied.</done>
</task>

</tasks>

<verification>
1. `docker-compose exec app php artisan migrate:status` -- all migrations ran
2. `curl -s http://localhost:8000/api/v1/health` -- returns JSON with status ok
3. `docker-compose exec app php artisan tinker --execute="echo App\Models\Invoice::query()->toSql();"` -- confirms model connects to invoices table
4. `docker-compose exec app php artisan route:list --path=api` -- shows /api/v1/health route
</verification>

<success_criteria>
- invoices and invoice_items tables exist with all columns matching the schema from research
- Invoice and InvoiceItem models have proper relationships (belongsTo/hasMany)
- GET /api/v1/health returns 200 with JSON body
- All API routes are prefixed with /api/v1/
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-docker/01-02-SUMMARY.md`
</output>
