---
phase: 02-auth-api-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/Providers/AppServiceProvider.php
  - bootstrap/app.php
autonomous: true
requirements: [INFR-01, INFR-03]

must_haves:
  truths:
    - "All /api/* error responses return JSON, never HTML"
    - "A 'parse' rate limiter exists that limits to 10 requests per minute per user"
    - "404 errors on API routes return JSON with message"
    - "500 errors on API routes return JSON with message"
    - "Unauthenticated errors (401) on API routes return JSON"
  artifacts:
    - path: "app/Providers/AppServiceProvider.php"
      provides: "Rate limiter definitions"
      contains: "RateLimiter::for"
    - path: "bootstrap/app.php"
      provides: "JSON-only exception rendering for API routes"
      contains: "shouldRenderJsonWhen"
  key_links:
    - from: "app/Providers/AppServiceProvider.php"
      to: "Illuminate\\Cache\\RateLimiting\\Limit"
      via: "RateLimiter::for('parse')"
      pattern: "perMinute\\(10\\)"
    - from: "bootstrap/app.php"
      to: "exception handler"
      via: "shouldRenderJsonWhen closure"
      pattern: "request->is\\('api/\\*'\\)"
---

<objective>
Configure rate limiting for the parse endpoint and enforce JSON-only error responses for all API routes.

Purpose: API clients always receive structured JSON errors (never HTML pages), and the future parse endpoint is rate-limited to 10 requests/minute per user to prevent abuse.
Output: AppServiceProvider with rate limiter definitions, bootstrap/app.php with JSON error enforcement.
</objective>

<execution_context>
@/Users/valerijbakalenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/valerijbakalenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-auth-api-infrastructure/02-RESEARCH.md
@bootstrap/app.php
@app/Providers/AppServiceProvider.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: JSON error handling and rate limiter configuration</name>
  <files>
    bootstrap/app.php
    app/Providers/AppServiceProvider.php
  </files>
  <action>
    1. Update bootstrap/app.php to force JSON errors for all API routes:
       - In the withExceptions closure, add:
         ```
         $exceptions->shouldRenderJsonWhen(function (Request $request, Throwable $e) {
             return $request->is('api/*');
         });
         ```
       - Add necessary imports at top: `use Illuminate\Http\Request;` and `use Throwable;`
       - Keep existing withRouting and withMiddleware sections unchanged

    2. Update AppServiceProvider boot() method with rate limiter definitions:
       - Add imports: `use Illuminate\Cache\RateLimiting\Limit;`, `use Illuminate\Http\Request;`, `use Illuminate\Support\Facades\RateLimiter;`
       - Define 'api' rate limiter: 60 requests/minute, keyed by user ID or IP fallback
         ```
         RateLimiter::for('api', function (Request $request) {
             return Limit::perMinute(60)->by($request->user()?->id ?: $request->ip());
         });
         ```
       - Define 'parse' rate limiter: 10 requests/minute, keyed by user ID or IP fallback
         ```
         RateLimiter::for('parse', function (Request $request) {
             return Limit::perMinute(10)->by($request->user()?->id ?: $request->ip());
         });
         ```

    Note: The 'parse' rate limiter is defined here but will be applied to the actual parse route in Phase 3 when that endpoint is created. The middleware application will be: `['auth:sanctum', 'throttle:parse']` (auth BEFORE throttle so rate limiting keys by user ID, not IP).
  </action>
  <verify>
    Test JSON error on 404:
    `curl -s http://localhost:8000/api/v1/nonexistent | python3 -m json.tool`
    Should return JSON with "message" key, not HTML.

    Test JSON error on unauthenticated:
    `curl -s http://localhost:8000/api/v1/user | python3 -m json.tool`
    Should return JSON: {"message": "Unauthenticated."} with 401 status (once Plan 01 routes exist).

    Verify rate limiter is registered:
    `docker-compose exec app php artisan tinker --execute="echo app(\Illuminate\Cache\RateLimiting\RateLimiter::class)->limiter('parse') ? 'REGISTERED' : 'MISSING';"`
    Should output REGISTERED.
  </verify>
  <done>All API error responses (404, 401, 403, 422, 500) return structured JSON with message field. Parse rate limiter registered at 10 req/min per user. API rate limiter registered at 60 req/min.</done>
</task>

</tasks>

<verification>
1. GET /api/v1/nonexistent returns JSON 404 (not HTML)
2. GET /api/v1/user without auth returns JSON 401 (not HTML)
3. Parse rate limiter exists and is configured for 10 req/min
4. API rate limiter exists and is configured for 60 req/min
5. Rate limiters key by user ID when authenticated, IP when not
</verification>

<success_criteria>
- No API route ever returns HTML error pages
- Rate limiters registered and ready for route application
- Error responses contain "message" field with appropriate HTTP status codes
</success_criteria>

<output>
After completion, create `.planning/phases/02-auth-api-infrastructure/02-02-SUMMARY.md`
</output>
