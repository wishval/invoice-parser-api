---
phase: 04-pdf-parsing-ai
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - app/Services/InvoiceParser.php
  - app/Data/InvoiceSchema.php
  - app/Jobs/ParseInvoiceWithAI.php
autonomous: true
requirements: [PARS-02, PARS-03, PARS-04, PARS-05, PARS-06, PARS-07, PARS-09]
user_setup:
  - service: openai
    why: "GPT-4o Vision API for invoice data extraction"
    env_vars:
      - name: OPENAI_API_KEY
        source: "OpenAI Dashboard -> API keys -> Create new secret key"
    dashboard_config: []

must_haves:
  truths:
    - "All page images from a multi-page PDF are sent to OpenAI GPT-4o Vision in a single request"
    - "OpenAI returns structured JSON with vendor, customer, metadata, totals, and line items"
    - "Each major section includes a confidence score (0-100)"
    - "The parsed data is stored as JSON for the next job to consume"
  artifacts:
    - path: "app/Data/InvoiceSchema.php"
      provides: "JSON schema definition for OpenAI Structured Outputs"
      min_lines: 40
    - path: "app/Services/InvoiceParser.php"
      provides: "OpenAI Vision API call with base64 images"
      min_lines: 50
    - path: "app/Jobs/ParseInvoiceWithAI.php"
      provides: "Job that reads image manifest, calls InvoiceParser, writes parsed JSON"
      min_lines: 30
  key_links:
    - from: "app/Jobs/ParseInvoiceWithAI.php"
      to: "app/Services/InvoiceParser.php"
      via: "dependency injection or instantiation"
      pattern: "InvoiceParser"
    - from: "app/Services/InvoiceParser.php"
      to: "OpenAI facade"
      via: "OpenAI::chat()->create()"
      pattern: "OpenAI::chat"
    - from: "app/Services/InvoiceParser.php"
      to: "app/Data/InvoiceSchema.php"
      via: "schema method call"
      pattern: "InvoiceSchema"
---

<objective>
Create the OpenAI Vision integration that extracts structured invoice data from page images.

Purpose: The core AI feature -- sending invoice images to GPT-4o Vision with a strict JSON schema to extract vendor, customer, metadata, totals, line items, and confidence scores.
Output: Working ParseInvoiceWithAI job that reads the image manifest from Plan 01, calls OpenAI, and writes parsed data JSON for Plan 03.
</objective>

<execution_context>
@/Users/valerijbakalenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/valerijbakalenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-pdf-parsing-ai/04-RESEARCH.md
@.planning/phases/04-pdf-parsing-ai/04-01-SUMMARY.md
@app/Jobs/ParseInvoiceWithAI.php
@app/Models/Invoice.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InvoiceSchema and InvoiceParser service</name>
  <files>app/Data/InvoiceSchema.php, app/Services/InvoiceParser.php</files>
  <action>
Create `app/Data/InvoiceSchema.php`:
- Static method `schema(): array` returning the full JSON schema for OpenAI Structured Outputs
- The schema MUST use `"strict": true` and `"additionalProperties": false` at every object level
- Required top-level sections: vendor, customer, metadata, totals, line_items, confidence
- Vendor fields: name (string|null), address (string|null), tax_id (string|null)
- Customer fields: name (string|null), address (string|null), tax_id (string|null)
- Metadata fields: invoice_number (string|null), invoice_date (string|null), due_date (string|null), currency (string|null)
- Totals fields: subtotal (number|null), tax_amount (number|null), total (number|null)
- Line items: array of objects with description (string), quantity (number), unit_price (number), amount (number), tax (number|null)
- Confidence section: object with fields for each major section -- vendor (integer 0-100), customer (integer 0-100), metadata (integer 0-100), totals (integer 0-100), line_items (integer 0-100)
- Use `["type" => "string", "null"]` pattern for nullable fields (OpenAI Structured Outputs requires explicit null type)
- ALL objects must have `"additionalProperties" => false` (required for strict mode)
- ALL objects must have a `"required"` array listing every property

Create `app/Services/InvoiceParser.php`:
- Method: `parse(array $imagePaths): array` returns the extracted data array
- Build messages array:
  1. System message: "You are an invoice data extraction assistant. Extract all fields from the invoice images. For fields you cannot find or read, return null. For confidence scores, rate 0-100 how confident you are in each section's extraction accuracy. Return 0 confidence if the section data is mostly null."
  2. User message with content array: first element is text "Extract all invoice data from the following document pages.", followed by one image_url element per page
  3. Each image: base64-encode via `base64_encode(file_get_contents($imagePath))`, format as `data:image/jpeg;base64,{$base64}`
  4. Use `detail: 'high'` for all images (invoices need text clarity)
- Call `OpenAI::chat()->create()` with:
  - model: `gpt-4o-2024-08-06` (required for Structured Outputs)
  - messages: the built array
  - response_format: json_schema with InvoiceSchema::schema(), name 'invoice_extraction', strict true
  - max_tokens: 4096
- Decode the response: `json_decode($response->choices[0]->message->content, true)`
- If json_decode returns null, throw RuntimeException with "Failed to decode OpenAI response"
- Return the decoded array
- Add ThrottlesExceptions middleware support: method `middleware(): array` is on the job, not here. But do handle OpenAI client exceptions gracefully -- catch and re-throw with context.
  </action>
  <verify>
- `app/Data/InvoiceSchema.php` exists with schema() method returning array with all 5 top-level sections + confidence
- `app/Services/InvoiceParser.php` exists with parse() method using OpenAI facade
- Both files have proper namespace declarations and are autoloadable:
  `docker compose exec app php artisan tinker --execute="echo class_exists(\App\Data\InvoiceSchema::class) && class_exists(\App\Services\InvoiceParser::class) ? 'OK' : 'FAIL';"`
  </verify>
  <done>InvoiceSchema defines strict JSON schema for OpenAI with vendor, customer, metadata, totals, line_items, and confidence sections. InvoiceParser sends base64-encoded page images to GPT-4o Vision and returns decoded structured data.</done>
</task>

<task type="auto">
  <name>Task 2: Implement ParseInvoiceWithAI job</name>
  <files>app/Jobs/ParseInvoiceWithAI.php</files>
  <action>
Update `app/Jobs/ParseInvoiceWithAI.php` (replace the stub):
- Keep existing: tries=3, timeout=300, WithoutRelations attribute on $invoice
- Add `public array $backoff = [30, 60, 120];` for exponential backoff on retries
- Add `public int $maxExceptions = 2;` to fail after 2 exceptions (not 3 retries of same error)
- Add middleware method returning ThrottlesExceptions:
  ```php
  public function middleware(): array
  {
      return [
          (new \Illuminate\Queue\Middleware\ThrottlesExceptions(10, 5 * 60))->backoff(30)
      ];
  }
  ```
- In handle():
  1. Read the manifest file: `$manifestPath = storage_path("app/temp/invoice_{$this->invoice->id}_manifest.json")`
  2. If manifest does not exist, throw RuntimeException("Image manifest not found for invoice {$this->invoice->id}")
  3. Decode manifest JSON to get array of image paths
  4. Verify each image path exists (file_exists), throw if any missing
  5. Instantiate InvoiceParser service: `$parser = new \App\Services\InvoiceParser()`
  6. Call `$parser->parse($imagePaths)` to get extracted data
  7. Write the parsed data to a JSON file: `storage_path("app/temp/invoice_{$this->invoice->id}_parsed.json")`
  8. Log success with invoice ID and number of fields extracted
- In failed(): update invoice status to 'failed' with error message (keep existing pattern)

The parsed JSON file acts as the handoff between ParseInvoiceWithAI and SaveParsedData jobs. This avoids passing large data through the job chain and keeps jobs independently retryable.
  </action>
  <verify>
- `app/Jobs/ParseInvoiceWithAI.php` no longer contains "placeholder" text
- File contains `InvoiceParser` usage, manifest file reading, parsed JSON writing
- File contains ThrottlesExceptions middleware and backoff array
- `docker compose exec app php artisan tinker --execute="echo (new ReflectionMethod(\App\Jobs\ParseInvoiceWithAI::class, 'handle'))->getNumberOfParameters() === 0 ? 'OK' : 'FAIL';"`
  </verify>
  <done>ParseInvoiceWithAI job reads image manifest, sends all images to OpenAI Vision via InvoiceParser service, writes parsed data JSON file. Includes exponential backoff and rate limit throttling for OpenAI API resilience.</done>
</task>

</tasks>

<verification>
- `app/Data/InvoiceSchema.php` defines complete schema with strict mode and all 6 sections
- `app/Services/InvoiceParser.php` calls OpenAI Vision with base64 images and structured output
- `app/Jobs/ParseInvoiceWithAI.php` reads manifest, calls parser, writes parsed JSON
- No placeholder stubs remain in ParseInvoiceWithAI
- Schema includes confidence scores (0-100) for each section (PARS-09)
- Schema includes vendor (PARS-03), customer (PARS-04), metadata (PARS-05), totals (PARS-06), line_items (PARS-07)
</verification>

<success_criteria>
- InvoiceSchema covers all required extraction fields with strict JSON schema
- InvoiceParser sends all page images to GPT-4o-2024-08-06 with Structured Outputs
- ParseInvoiceWithAI job is resilient with backoff, throttling, and proper error handling
- Parsed data flows via JSON file from AI parsing to the next job (SaveParsedData)
</success_criteria>

<output>
After completion, create `.planning/phases/04-pdf-parsing-ai/04-02-SUMMARY.md`
</output>
