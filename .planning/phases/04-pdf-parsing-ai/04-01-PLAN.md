---
phase: 04-pdf-parsing-ai
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - composer.json
  - composer.lock
  - config/openai.php
  - config/services.php
  - .env.example
  - app/Services/PdfConverter.php
  - app/Jobs/ConvertPdfToImages.php
autonomous: true
requirements: [PARS-01]

must_haves:
  truths:
    - "All pages of a multi-page PDF are converted to JPEG images at 150 DPI"
    - "Converted image paths are stored on the invoice for the next job to consume"
    - "spatie/pdf-to-image and openai-php/laravel packages are installed"
  artifacts:
    - path: "app/Services/PdfConverter.php"
      provides: "PDF to image conversion logic"
      min_lines: 30
    - path: "app/Jobs/ConvertPdfToImages.php"
      provides: "Job that converts PDF pages to temp images"
      min_lines: 25
    - path: "config/openai.php"
      provides: "OpenAI configuration file"
  key_links:
    - from: "app/Jobs/ConvertPdfToImages.php"
      to: "app/Services/PdfConverter.php"
      via: "dependency injection or direct instantiation"
      pattern: "PdfConverter"
    - from: "app/Services/PdfConverter.php"
      to: "spatie/pdf-to-image"
      via: "Spatie\\PdfToImage\\Pdf"
      pattern: "Spatie\\\\PdfToImage\\\\Pdf"
---

<objective>
Install PDF and OpenAI dependencies, create PdfConverter service, and implement the ConvertPdfToImages job.

Purpose: The first step in the parsing pipeline -- converting PDF pages to images that OpenAI Vision can process.
Output: Working ConvertPdfToImages job that produces JPEG images from uploaded PDFs, plus installed OpenAI package ready for Plan 02.
</objective>

<execution_context>
@/Users/valerijbakalenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/valerijbakalenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pdf-parsing-ai/04-RESEARCH.md
@.planning/phases/03-upload-queue-processing/03-02-SUMMARY.md
@app/Jobs/ConvertPdfToImages.php
@app/Models/Invoice.php
@database/migrations/0001_01_01_000003_create_invoices_table.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and configure OpenAI</name>
  <files>composer.json, composer.lock, config/openai.php, .env.example</files>
  <action>
Run inside the Docker PHP container (docker compose exec app ...):

1. Install packages:
   ```
   composer require spatie/pdf-to-image:^3.0 openai-php/laravel
   ```

2. Publish OpenAI config:
   ```
   php artisan openai:install
   ```
   This creates config/openai.php. Verify it reads OPENAI_API_KEY and OPENAI_ORGANIZATION from env.

3. Add to .env.example (do NOT create/modify .env):
   ```
   OPENAI_API_KEY=
   OPENAI_ORGANIZATION=
   ```

4. Verify Imagick extension is available in the Docker container:
   ```
   php -m | grep imagick
   ```
   If not present, the Dockerfile from Phase 1 should already have it (it was a Phase 1 requirement). If missing, add `php8.3-imagick` to the Dockerfile apt-get install line and rebuild.

Do NOT configure services.php for OpenAI -- the openai-php/laravel package uses its own config/openai.php.
  </action>
  <verify>
Run inside Docker container:
- `php artisan tinker --execute="echo class_exists(\Spatie\PdfToImage\Pdf::class) ? 'OK' : 'FAIL';"` outputs OK
- `php artisan tinker --execute="echo class_exists(\OpenAI\Laravel\Facades\OpenAI::class) ? 'OK' : 'FAIL';"` outputs OK
- `php -m | grep imagick` shows imagick
- `cat .env.example | grep OPENAI` shows both env vars
  </verify>
  <done>Both packages installed, OpenAI config published, .env.example updated with OPENAI keys, Imagick extension confirmed available.</done>
</task>

<task type="auto">
  <name>Task 2: Create PdfConverter service and implement ConvertPdfToImages job</name>
  <files>app/Services/PdfConverter.php, app/Jobs/ConvertPdfToImages.php</files>
  <action>
Create `app/Services/PdfConverter.php`:
- Method: `convert(string $pdfPath, int $invoiceId): array` returns array of image file paths
- Use `Spatie\PdfToImage\Pdf` class
- Set resolution to 150 DPI BEFORE any page operations (critical -- resolution must be set before loading)
- Set output format to 'jpg' with quality 85
- Get page count via `$pdf->pageCount()`
- Loop through each page: `$pdf->selectPage($pageNumber)->save($outputPath)`
- Output path pattern: `storage_path("app/temp/invoice_{$invoiceId}_page_{$pageNumber}.jpg")`
- Create the `storage/app/temp` directory if it does not exist (use `File::ensureDirectoryExists`)
- Return array of all created image paths
- Throw a descriptive RuntimeException if conversion fails (e.g., Imagick error, file not found)

Update `app/Jobs/ConvertPdfToImages.php` (replace the stub):
- Keep existing: tries=3, timeout=300, WithoutRelations, failed() method
- In handle():
  1. Get the full storage path: `Storage::disk('local')->path($this->invoice->stored_path)`
  2. Instantiate PdfConverter and call convert()
  3. Store the image paths as JSON on the invoice. The invoice model does not have a temp_image_paths column, so use a JSON file approach instead: write the paths array to `storage_path("app/temp/invoice_{$id}_manifest.json")`
  4. Log the number of pages converted
- In failed(): update invoice status to 'failed' with error message (consistent with chain catch pattern, but provides job-level granularity)

Important: Do NOT add a new migration column for temp image paths. Use a manifest JSON file in the temp directory instead -- these are transient and will be cleaned up by CleanupTempFiles.
  </action>
  <verify>
- File `app/Services/PdfConverter.php` exists and contains `Spatie\PdfToImage\Pdf` usage
- File `app/Jobs/ConvertPdfToImages.php` no longer contains "placeholder" text
- `docker compose exec app php artisan tinker --execute="echo class_exists(\App\Services\PdfConverter::class) ? 'OK' : 'FAIL';"` outputs OK
  </verify>
  <done>PdfConverter service converts all PDF pages to 150 DPI JPEG images. ConvertPdfToImages job reads the stored PDF path, converts all pages, and writes a manifest JSON file with image paths for the next job in the chain.</done>
</task>

</tasks>

<verification>
- `composer show spatie/pdf-to-image` shows ^3.0
- `composer show openai-php/laravel` shows installed version
- `config/openai.php` exists with OPENAI_API_KEY config
- `app/Services/PdfConverter.php` exists with convert() method
- `app/Jobs/ConvertPdfToImages.php` uses PdfConverter, writes manifest file
- No "placeholder" or "Log::info" only stubs remain in ConvertPdfToImages
</verification>

<success_criteria>
- Both composer packages installed and autoloadable
- PdfConverter service handles multi-page PDFs with 150 DPI / 85% quality JPEG output
- ConvertPdfToImages job reads invoice stored_path, converts all pages, writes manifest JSON
- OpenAI config ready for Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/04-pdf-parsing-ai/04-01-SUMMARY.md`
</output>
